\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}
\begin{document}
\subsection*{}
We outline a strategy for relative astrometry with spatially variable adaptive optics point spread functions (PSFs). We summarize the necessary definitions and underlying assumptions, and present a detailed methodology for maintaining the positional relation between the individual PSFs when modeling the spatially variable effects due to atmospheric anisoplanatism and instrumental aberrations. This methodology, which properly defines the astrometric center of each PSF, is the centerpiece of an improved astrometry that takes into account the spatial variability of the PSF-shapes.

\subsection{The reference point problem}

The problem discussed in this short outline can be described best with the sketch shown in Fig.~\ref{fig:frog}. 

In the case of a constant PSF the astrometric reference point is usually calculated from the (empirical) center of light (centroid) calculated on the empirical PSF with finite support (in our case estimated from the science data itself). In general, this center coincides with neither the true mathematical center of light (calculated as an integral over an infinite domain), nor the true position of the object (more on the definition of the true position in the following section). On the other hand, since the PSF is (assumed to be) constant, the difference between true position and centroid - although unknown - is always the same for all positions in the field of view, and thus relative astrometric measurements remain unaffected.

{\bf In order to understand the problems occurring in the case of astrometry with variable PSFs it is helpful to think in terms of three different coordinate systems: one with its origin at the true position, one with its origin at a reference point calculated from the intensity distribution of the PSF itself (e.g., the empirical or the mathematical centroid), and one with its origin at the central pixel of the array used to represent the PSF for the PSF fitting algorithm (assumed to be the true position within Starfinder).}

\begin{figure}[h!]
\centering
\includegraphics[width=0.7\textwidth]{psf1.png}
\includegraphics[width=0.7\textwidth]{psf2.png}
\includegraphics[width=0.7\textwidth]{psf3.png}
\caption{\label{fig:frog}The problem of maintaining the positional relation between variable PSFs throughout modeling.}
\end{figure}

It is not sufficient in the case of variable PSFs to estimate the empirical centroid on each individual PSF as the astrometric reference because it is unknown what effect the individual shape has on the centroid measurement (additionally, this depends on the particular method for calculating the center of light). As a result, the difference between the true position and the measured center is different for each of the PSFs, and contributes to the systematics in the relative astrometry.

It is essential to maintain the positional relation between the individual modeled PSFs. In our sequence of analysis steps this means to first extract an 'on-axis' estimate (no atmospheric anisoplanatism, no instrumental aberrations other than at the image-sharpening position on the detector) and to center this estimate with some centroiding algorithm. {\bf Centering here means to shift the empirical reference point within the PSF to the pixel that defines the astrometric reference for the PSF-fitting algorithm, in our case the central pixel of the PSF array.} In the next steps of propagating the PSFs to off-axis positions the relation between the true position and the central pixel has to be conserved. In order to keep this relation invariant we have to understand the effect that optical aberrations have on the difference between true position and the reference point calculated from the PSF.  

\subsection{The relation between the true position and the center of light}

In the following we mainly summarize key results of Mahajan (1985), 'The Line of Sight of an Aberrated Optical System', and apply them to our strategy for astrometric measurements with field variable PSFs.
\begin{figure}[h!]
\centering
\includegraphics[width=0.7\textwidth]{op.png}
\caption{\label{fig:op}The relation between PSF, OTF, and pupil function.}
\end{figure}
It is helpful to recall some basic definitions. The pupil function is defined as:
\begin{equation}
P(u,v) = \left\{\begin{array}{cl} A(u,v) \cdot \exp\big[W(u,v)\big], & \mbox{inside pupil}\\ 
0, & \mbox{outside pupil} \end{array}\right.
\end{equation}
with $W(u,v)$ the phase aberrations (phase map in radian) at a point $(u,v)$ in the exit pupil plane, and the amplitude
\begin{equation}\label{amp}
A(u,v) = 1 \; \forall (u,v)
\end{equation}

The PSF is the power spectrum of the pupil function:
\begin{equation}
I(x,y) \propto \Big \lvert \iint\limits_{-\infty}^{\: +\infty} P(u,v) \cdot \exp\Big(\frac{-2\pi i (xu+yv)}{\lambda R}\Big)\; dudv \Big \rvert
\end{equation}
with $R$ the radius of the pupil (in our case the radius of open pupil for which our phase maps are calculated), and the $\lambda$ the wavelength of the light. The center of light of the PSF can be calculated from $I(x,y)$ with
\begin{eqnarray}
\langle x \rangle = E^{-1} \iint\limits_{-\infty}^{\: +\infty} x \cdot I(x,y) \; dxdy \label{cl1}\\
\langle y \rangle = E^{-1} \iint\limits_{-\infty}^{\: +\infty} y \cdot I(x,y) \; dxdy \label{cl2}
\end{eqnarray}
with the total flux
\begin{equation}
E = \iint\limits_{-\infty}^{\; +\infty} I(x,y) \: dxdy
\end{equation}

The optical transfer function (OTF; $\tau$) is defined as the Fourier transform of the PSF:
\begin{equation}\label{ft}
\tau(\xi,\eta) = FT\big[I(x,y)\big] = E^{-1} \iint\limits_{-\infty}^{\: +\infty} I(x,y) \exp[2 \pi i (\xi x + \eta y)] \; dxdy
\end{equation}

Analogue to Eqs.~\ref{cl1} and \ref{cl2}, the relation between the center of light and the OTF is given by:
\begin{eqnarray}
\langle x \rangle = \frac{1}{2\pi i} \cdot \Big(\frac{\partial \tau(\xi, \eta)}{\partial \xi}\Big)_{\xi = \eta = 0} \\
\langle y \rangle = \frac{1}{2\pi i} \cdot \Big(\frac{\partial \tau(\xi, \eta)}{\partial \eta}\Big)_{\xi = \eta = 0}
\end{eqnarray}
with $\tau$ the FT of the {\it normalized} PSF. Since $\langle x \rangle$ and $\langle y \rangle$ are real, it follows:
\begin{eqnarray}
\langle x \rangle = \frac{1}{2\pi} \cdot \Big(\frac{\partial \Im[\tau(\xi, \eta)]}{\partial \xi}\Big)_{\xi = \eta = 0} \\
\langle y \rangle = \frac{1}{2\pi} \cdot \Big(\frac{\partial \Im[\tau(\xi, \eta)]}{\partial \eta}\Big)_{\xi = \eta = 0}
\end{eqnarray}
and
\begin{equation}\label{con1}
\Re\Bigg[\Big(\frac{\partial \tau(\xi, \eta)}{\partial \xi}\Big)_{\xi = \eta = 0}\Bigg] = \Re\Bigg[\Big(\frac{\partial \tau(\xi, \eta)}{\partial \eta}\Big)_{\xi = \eta = 0}\Bigg] = 0
\end{equation}
with $\Im(\tau)$ and $\Re(\tau)$ the imaginary and the real part of the OTF.

For the following it is helpful to remeber some symmetry constrains of the OTF.
Because the PSF is a real, positive quantity $I(x,y) > 0 \; \forall x,y$ the OTF satisfies the symmetry condition:
\begin{equation}\label{sym}
\tau(-\xi, -\eta) = \tau^{\ast}(\xi,\eta)
\end{equation}
with $\tau^{\ast}$ the complex conjugate to $\tau$. In particular, with Eqs.~\ref{sym} and \ref{ft} it follows:
\begin{eqnarray}
\Re[\tau(0,0)] = 1 \\
\Im[\tau(0,0)] = 0 \label{con2}
\end{eqnarray}

We define the true position as the center of curvature of the reference sphere of our optical system, with the chief ray (defining the line of sight) running through the center of curvature of the reference sphere and the center of the exit pupil (see Fig.~\ref{fig:tp}).
\begin{figure}[h!]
\centering
\includegraphics[width=0.7\textwidth]{truepos.png}
\caption{\label{fig:tp}We define the "true" astrometric position as that given by the chief ray of the optical system passing from the source (at infinity) through the center of the pupil.  The intersection of this ray with the focal plane also defines the center of the reference sphere.}
\end{figure}
A main result of Mahajan (1985) is the fact that for the aberration free case even under inhomogeneous illumination of the pupil the true position is aligned with the (mathematical) center of light and the maximum pixel. In the case of aberrations, however, these three reference points deviate from each other, generally. If we describe $I(x,y)$ in the coordinate system with origin at the true position then $(\langle x \rangle, \langle y \rangle)$ from Eqs.~\ref{cl1} and \ref{cl2} is the deviation of the center of light from the true position. For our further arguments we use this convention, i.e., $\langle x \rangle = \langle y \rangle$ = 0 for an aberration free system.

We model the spatially variable PSFs as the convolution of  three PSF-kernels:

\begin{equation}
\rm{OTF}_{\rm{off-axis}} = \rm{OTF}_{\rm{on-axis}} \cdot \rm{OTF}_{\rm{atm.}} \cdot \rm{OTF}_{\rm{instr.}}
\end{equation}

For the product of two OTFs we find with Eq.~\ref{con1} through \ref{con2} the resulting center of light to be the vector sum of the centroids of the individual factors:

\begin{equation}
\tau  = \tau_1 \cdot \tau_2 = (a + bi)\cdot (c + di)
\end{equation}

with $a = \Re(\tau_1)$, $b = \Im(\tau_1)$, $c = \Re(\tau_2)$, and $d = \Im(\tau_2)$. Then we find:

\begin{align}
\langle x \rangle_{\tau} & = \frac{1}{2\pi} \cdot \Big(\frac{\partial}{\partial\xi}\Im[\tau]\Big)_{\xi = \eta = 0} = \frac{1}{2\pi} \cdot \Big(\frac{\partial}{\partial\xi}(bc+ad)\Big)_{\xi = \eta = 0}\nonumber \\ 
& = \frac{1}{2\pi} \cdot \Big(\frac{\partial}{\partial\xi}b \cdot c + b \cdot \frac{\partial}{\partial\xi}c + \frac{\partial}{\partial\xi}a \cdot d + a \cdot \frac{\partial}{\partial\xi}d\Big)_{\xi = \eta = 0}\nonumber \\
& = \frac{1}{2\pi} \cdot \Big(\frac{\partial}{\partial\xi}b + \frac{\partial}{\partial\xi}d\Big)_{\xi = \eta = 0}\nonumber \\
& = \langle x \rangle_{\tau_1} + \langle x \rangle_{\tau_2}
\end{align}

(and for $\langle y \rangle$ likewise) and thus
 
\begin{equation}
\begin{bmatrix}
        \langle x \rangle \\ \langle y \rangle \end{bmatrix}_{\rm{off-axis}} = \begin{bmatrix} \langle x \rangle \\ \langle y \rangle\end{bmatrix}_{\rm{on-axis}} + \begin{bmatrix}\langle x \rangle \\ \langle y \rangle\end{bmatrix}_{\rm{atm.}} + \begin{bmatrix}\langle x \rangle \\ \langle y \rangle\end{bmatrix}_{\rm{instr.}}
\end{equation}

This is the key result for our problem because it allows us to separate time-variable and field-variable contributors. In our case we have both a static (i.e. constant in time) contributor, a spatially - i.e. with field position $(x',y')$ - invariant contributor, and a mixed contributor: 

\begin{equation}\label{dep}
\rm{OTF}_{\rm{off-axis}}(x',y',t)  =  \rm{OTF}_{\rm{on-axis}}(t)  \cdot  \rm{OTF}_{\rm{atm.}}(x',y',t)  \cdot  \rm{OTF}_{\rm{instr.}}(x',y')
\end{equation} 

and accordingly:

\begin{equation}
\underbrace{\begin{bmatrix}
        \langle x \rangle \\ \langle y \rangle \end{bmatrix}_{\rm{off-axis}}}_{(x',y',t)} = \underbrace{\begin{bmatrix} \langle x \rangle \\ \langle y \rangle\end{bmatrix}_{\rm{on-axis}}}_{(t)} + \underbrace{\begin{bmatrix}\langle x \rangle \\ \langle y \rangle\end{bmatrix}_{\rm{atm.}}}_{(x',y',t)} + \underbrace{\begin{bmatrix}\langle x \rangle \\ \langle y \rangle\end{bmatrix}_{\rm{instr.}}}_{(x',y')}
\end{equation}

 
Eq.~\ref{dep} shows that an empirical centroid estimation (e.g., defined as the centroid calculation over a non-infinte support around the maximum pixel from a noisy estimate of the PSF, or any of the above) on $I_{\rm{off-axis}}(x,y; x',y',t)$ (where $I(x,y)$ is unknown for large $x,y$) becomes dependent on both field position and time. Consequentely, it is not useful as astrometric reference. However, we see that the first term on the right side of Eq.~\ref{dep} has no field dependence. Since the centroid deviations are additive, we can tolerate an offset in this terms and any choice of an astrometic reference point is valid. If our further PSF-modeling with the atmospheric and instrumental OTFs preserves the initial relation between the astrometric reference (the point in the 'on-axis PSF' that we placed in the center of our PSF array) and the true position, we avoid systematics in our relative astrometry.

In order to estimate the first term (the 'on-axis PSF'), we use an number of reference stars which we deconvolve with both the atmospheric and instrumental kernel. Assuming that the resulting on-axis estimates are sufficiently similar in shape, we apply an arbitrary PSF-centering method (e.g., StarFinders centroider that uses the centroid of the innermost FWHM box around the maximum of the PSF). We then average the individual deconvolved and centered reference stars. We obtain an 'on-axis' PSF with an astrometric reference $[\langle x \rangle , \langle y \rangle]_{\rm{on-axis}}$ which has an unknown deviation from the true position and is different for each frame, but which is independent on the field position. 

While we have to make sure that the center of light is strictly zero for the atmospheric kernel which is variable with both time and position, we have two options for the static instrumental part:

\begin{enumerate}

\item
We make sure that $[\langle x \rangle , \langle y \rangle]_{\rm{instr.}}$ is zero. This is most precisely done using the relation between the the aberration function $W(u,v)$ and the center of light:
\begin{equation}
\langle x \rangle = \frac{R}{E} \iint \limits_S I(u,v) \frac{\partial W(u,v)}{\partial u} \; du dv
\end{equation}
(and $\langle y \rangle$ likewise) with $I(u,v) = A(u,v)^2$ the illumination of the pupil (assumed to be uniform in our case, see Eq.~\ref{amp}), $R$ the radius of the circular open NIRC2 pupil, and $E$ the total flux. $W(u,v)$ is our phase map after applying the hexagonal pupil.
\item
We use a different centering scheme for the instrumental kernel ( e.g., centering on the maximum of the kernel). Because this term is independent on time it is possible to account for the displacement with a look-up table or the distortion map. 
\end{enumerate}

It is the best way to use method 1 because we avoid further complications with look-up tables or additional contributions in the distortion correction that are not caused by geometric distortion.
\end{document]
  
  